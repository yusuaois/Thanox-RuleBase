[{"name": "管家中枢者","description": "by诗里沧海怨怼 | 灭霸版本≥5.2.0","priority": -1,"condition": "systemReady||shortcutLaunched&&shortcutValue=='trimOn'","actions": ["import java.util.ArrayList;import java.util.HashMap;import java.util.HashSet;import java.nio.file.Paths;import java.nio.file.Files;import java.nio.charset.StandardCharsets;ui.showShortToast('管家初始化中...');parseCnt=0;fp=thanos.profileManager.getLogPath();fp=fp.substring(0,fp.length()-38);curThread=Thread.currentThread();ruleKV.put('bgManagerThread',curThread);curThread.setPriority(Thread.MAX_PRIORITY);nMap=new HashMap();rMap=new java.util.concurrent.ConcurrentHashMap();rMapBak=new HashMap();cMap=new HashMap();cntMap=new HashMap();aSet=new HashSet();tSet=new HashSet();noSet=new HashSet();minV=Long.MAX_VALUE;isSuAPI=false;if(true){conf1=Paths.get(fp,'profile_user_io/管家配置.conf');if(Files.notExists(conf1)){ui.showShortToast('管家配置.conf不存在!');return;}strings=Files.readAllLines(conf1,StandardCharsets.UTF_8);if(true){strings1=new ArrayList();for(str:strings){if(++parseCnt==50){Thread.sleep(150);parseCnt=0;}str=str.trim();if(!str.isEmpty()){ch=str.charAt(0);if(ch!='#'&&ch!='['){strings1.add(str);}}}strings=strings1;}strs=strings.get(0).split('=')[1].trim().split('[,，]');cycleTime=Integer.parseInt(strs[0]);diff=Integer.parseInt(strs[1]);isSuAPI='suapi'.equalsIgnoreCase(strings.get(1).split('=')[1].trim());compile=java.util.regex.Pattern.compile('[TtKkMm] +(?<pkgName>\\\\S+) +(?<note>\\\\S+) +(?<ids>(?:\\\\d+[,，])*\\\\d+)# +(?<times>-?\\\\d+[,，]\\\\d+) +(?<tags>\\\\d{8})');size=strings.size();errInfo=new StringBuilder();parseCnt=0;for(i=2;i<size;i++){if(++parseCnt==46){Thread.sleep(150);parseCnt=0;}str=strings.get(i);matcher=compile.matcher(str);if(matcher.find()){mtime=0;ch=str.charAt(0);cntNums=null;if(ch=='K'||ch=='k'){mtime=1;}else if(ch=='M'||ch=='m'){mtime=2;cntNums=new int[]{2,2};}pkgName=matcher.group('pkgName');note=matcher.group('note');nMap.put(pkgName,note);ids=matcher.group('ids').split('[,，]');times=matcher.group('times').split('[,，]');backTime=(cycleTime+Integer.parseInt(times[0])*diff)*1000;backTime=backTime<30000?30000:backTime;cntNum=Integer.parseInt(times[1]);if(cntNum>1){cntNums=new int[]{cntNum,cntNum};}tags=matcher.group('tags').toCharArray();if(tags[0]=='1'){mtime|=4;}if(tags[1]=='1'){aSet.add(pkgName);}if(tags[2]=='1'){tSet.add(pkgName);}for(idStr:ids){pkg1=Pkg.newPkg(pkgName,Integer.parseInt(idStr));curT=System.currentTimeMillis();rMap.put(pkg1,curT);rMapBak.put(pkg1,curT);mtime+=backTime;minV=Math.min(minV,mtime);cMap.put(pkg1,mtime);if(cntNums!=null){cntMap.put(pkg1,cntNums);}}}else{errInfo.append(str).append(' | ').append('格式不正确\n');}}io.write('管家报错信息.log',errInfo.toString());if(cMap.size()==0){ui.showShortToast('管家配置->变量为空!');return;}conf1=Paths.get(fp,'profile_user_io/瘦身保留的进程.conf');if(Files.notExists(conf1)){ui.showShortToast('瘦身保留的进程.conf不存在!');return;}strings=Files.readAllLines(conf1,StandardCharsets.UTF_8);parseCnt=0;for(str:strings){if(++parseCnt==50){Thread.sleep(150);parseCnt=0;}str=str.trim();if(!str.isEmpty()&&str.charAt(0)!='#'){noSet.add(str);}}}ruleKV.put('bgManagerLtt',rMap);sbTrim=new StringBuilder();sbKill=new StringBuilder();pat=java.time.format.DateTimeFormatter.ofPattern('MM/dd HH:mm:ss');procMaker=thanos.class.getClassLoader().loadClass('github.tornaco.android.thanos.core.os.ProcessName').getConstructor(String,int);procMaker.setAccessible(true);raFilter=new ArrayList();runAppList=new ArrayList();procNames=new Object[20];pRecords=new Object[20];logN='多开后台管家.log';st=100;aMan=thanos.activityManager;pMan=thanos.pkgManager;io.writeAppend(logN,'=============管家初始化完成=============\n');logSize=Files.size(Paths.get(fp,'profile_user_io',logN));ui.showShortToast('多开后台管家已开启');while(true){if(ruleKV.get('bgManagerThread')!=curThread){log.log(curThread.name+'终止运行=====');curThread.interrupt();}Thread.sleep(st);if(true){runApps=aMan.runningAppPackages;maxSize=runApps.size();j=Math.min(50,maxSize);for(i=0;i<j;i++){curPkg=runApps.get(i);if(cMap.containsKey(curPkg)){raFilter.add(curPkg);}}j=Math.min(100,maxSize);for(i=50;i<j;i++){curPkg=runApps.get(i);if(cMap.containsKey(curPkg)){raFilter.add(curPkg);}}j=Math.min(150,maxSize);for(i=100;i<j;i++){curPkg=runApps.get(i);if(cMap.containsKey(curPkg)){raFilter.add(curPkg);}}j=Math.min(200,maxSize);for(i=150;i<j;i++){curPkg=runApps.get(i);if(cMap.containsKey(curPkg)){raFilter.add(curPkg);}}j=Math.min(250,maxSize);for(i=200;i<j;i++){curPkg=runApps.get(i);if(cMap.containsKey(curPkg)){raFilter.add(curPkg);}}j=Math.min(300,maxSize);for(i=250;i<j;i++){curPkg=runApps.get(i);if(cMap.containsKey(curPkg)){raFilter.add(curPkg);}}}parseCnt=0;st=0;minT=minV;curT=System.currentTimeMillis();for(curPkg:raFilter){if(++parseCnt==50){Thread.sleep(150);parseCnt=0;}ltt=(long)rMap.get(curPkg);lttOld=(long)rMapBak.get(curPkg);if(lttOld!=ltt){cntInts=cntMap.get(curPkg);if(cntInts!=null){cntInts[0]=cntInts[1];}}cn=(long)cMap.get(curPkg);ntT=ltt+cn-curT;if(ntT<=2500){runAppList.add(curPkg);rMap.put(curPkg,curT);rMapBak.put(curPkg,curT);}else if(ntT<=10000){st=10000;}else{minT=Math.min(minT,ntT);}}st=(st!=0)?st:minT;if(runAppList.size()!=0){tork=false;focusApp=aMan.getTopVisibleActivities().get(0).name.getPackageName();label=focusApp;appInfo=pMan.getAppInfo(focusApp);if(appInfo!=null){label=appInfo.appLabel;label=(label==null||label=='')?focusApp:label;}sbKill.append('时间: ').append(java.time.LocalDateTime.now().format(pat)).append('\n正使用: ').append(label).append('\n|清理掉的后台|\n');sbTrim.append('|瘦身掉的进程|\n');parseCnt=0;frontApp=activity.frontAppPackage;for(curPkg:runAppList){if(++parseCnt==50){Thread.sleep(150);parseCnt=0;}name=curPkg.pkgName;id=curPkg.userId;cn=(long)cMap.get(curPkg);if(!(name.equals(frontApp)||name.equals(focusApp))){isplay=thanos.audioManager.hasAudioFocus(curPkg);isTrim=true;skip=true;if((cn&2)!=0){if(isplay){skip=false;cntInts=cntMap.get(curPkg);cntInts[0]=cntInts[1];}else if(!(tSet.contains(name)&&aMan.hasTopVisibleActivities(curPkg)||(cn&4)!=0&&thanos.notificationManager.hasShowingNotificationRecordsForPackage(curPkg))){skip=false;cntInts=cntMap.get(curPkg);cntInts[0]=cntInts[0]-1;if(cntInts[0]==0){isTrim=false;cntInts[0]=cntInts[1];}}}else{isTrim=(cn&1)==0;if(isTrim){cntInts=cntMap.get(curPkg);if(cntInts!=null){cntInts[0]=cntInts[0]-1;if(cntInts[0]==0){isTrim=false;cntInts[0]=cntInts[1];}}}skip=aSet.contains(name)&&isplay||tSet.contains(name)&&aMan.hasTopVisibleActivities(curPkg)||(cn&4)!=0&&thanos.notificationManager.hasShowingNotificationRecordsForPackage(curPkg);}if(!skip){if(isTrim){infoCnt=0;for(proc:aMan.getRunningAppProcessForPackage(curPkg)){if(++parseCnt==50){Thread.sleep(150);parseCnt=0;}if(!noSet.contains(proc.processName)){pRecords[infoCnt]=proc;procNames[infoCnt++]=procMaker.newInstance(proc.processName,id);}}if(infoCnt>0){if(isSuAPI){_profile.publishStringFactInternal(1,'trimSuAPI',0,java.util.Arrays.copyOf(pRecords,infoCnt));}else{_profile.publishStringFactInternal(1,'backAppTrim',0,java.util.Arrays.copyOf(procNames,infoCnt));}sbTrim.append(nMap.get(name)).append('{userId:').append(id).append('}\n');for(i=0;i<infoCnt;i++){if(++parseCnt==50){Thread.sleep(150);parseCnt=0;}pRecord=pRecords[i];sbTrim.append('进程号: ').append(pRecord.pid).append(' ').append(pRecord.processName).append('\n');}tork=true;}}else{_profile.publishStringFactInternal(1,'backAppKill',0,new Object[]{curPkg});sbKill.append(nMap.get(name)).append('{userId:').append(id).append('}\n');tork=true;}}}}if(tork){logStr=sbKill.append(sbTrim).append('---------------\n').toString();if(logSize>=131072){logSize=0;io.write(logN,logStr);}else{io.writeAppend(logN,logStr);}logSize+=logStr.getBytes(StandardCharsets.UTF_8).length;}sbTrim.setLength(0);sbKill.setLength(0);runAppList.clear();}raFilter.clear();}"]}]