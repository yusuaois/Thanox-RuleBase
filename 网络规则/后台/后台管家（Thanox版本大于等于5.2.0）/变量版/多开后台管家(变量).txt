[{"name": "多开后台管家（变量）","description": "by诗里沧海怨怼 | 定时 | 清理 瘦身 | 后台应用 | 要求thanox版本5.0.8+","priority": -1,"condition": "systemReady||shortcutLaunched&&shortcutValue=='trimOn'","actions": ["import java.util.ArrayList;import java.util.HashMap;import java.util.HashSet;import java.nio.file.Paths;import java.nio.file.Files;import java.nio.charset.StandardCharsets;_cycleTime=60;ui.showShortToast('管家初始化中...');parseCnt=0;fp=thanos.profileManager.getLogPath();fp=fp.substring(0,fp.length()-38);curThread=Thread.currentThread();ruleKV.put('bgManagerThread',curThread);curThread.setPriority(Thread.MAX_PRIORITY);nMap=new HashMap();rMap=new java.util.concurrent.ConcurrentHashMap();rMapBak=new HashMap();cMap=new HashMap();cntMap=new HashMap();pMan=thanos.pkgManager;minV=Long.MAX_VALUE;if(true){_cycleTime*=1000;trimSize=globalVarOf$trimApp.size();totalSize=trimSize+globalVarOf$killApp.size();if(totalSize+globalVarOf$musicApp.size()==0){return;}varList=new ArrayList(totalSize);varList.addAll(globalVarOf$trimApp);varList.addAll(globalVarOf$killApp);ui.showLongToast('读取trim、kill变量');for(int i=0;i<totalSize;i++){if(++parseCnt==45){Thread.sleep(150);parseCnt=0;}str=varList.get(i);if(str!=null){mtime=(i<trimSize)?0:1;if(str.charAt(str.length()-1)=='@'){mtime|=4;str=str.substring(0,str.length()-1);}strs=str.split(' ');appInfo=pMan.getAppInfoForUser(strs[0],0);label=strs[0];if(appInfo!=null){label=appInfo.appLabel;label=(label==null||label=='')?strs[0]:label;}if(strs.length==1){pkg1=Pkg.newPkg(strs[0],0);nMap.put(strs[0],label);curT=System.currentTimeMillis();rMap.put(pkg1,curT);rMapBak.put(pkg1,curT);mtime+=_cycleTime;minV=Math.min(minV,mtime);cMap.put(pkg1,mtime);}else{tmp=strs.length==3?strs[1]:label;nMap.put(strs[0],tmp);tmp=strs[strs.length-1];if(tmp.charAt(tmp.length()-1)=='#'){tmp=tmp.substring(0,tmp.length()-1);mtime+=_cycleTime;minV=Math.min(minV,mtime);curT=System.currentTimeMillis();for(id:tmp.split(',')){pkg1=Pkg.newPkg(strs[0],Integer.parseInt(id));rMap.put(pkg1,curT);rMapBak.put(pkg1,curT);cMap.put(pkg1,mtime);}}else{tmps=tmp.split('#');tmps1=tmps[tmps.length-1].split(',');mtime+=Math.max(30,Integer.parseInt(tmps1[0]))*1000;minV=Math.min(minV,mtime);cntNums=null;if(tmps1.length==2){cntNum=Integer.parseInt(tmps1[1]);cntNums=new int[]{cntNum,cntNum};}if(tmps.length==1){pkg1=Pkg.newPkg(strs[0],0);curT=System.currentTimeMillis();rMap.put(pkg1,curT);rMapBak.put(pkg1,curT);cMap.put(pkg1,mtime);if(cntNums!=null){cntMap.put(pkg1,cntNums);}}else{curT=System.currentTimeMillis();for(id:tmps[0].split(',')){pkg1=Pkg.newPkg(strs[0],Integer.parseInt(id));rMap.put(pkg1,curT);rMapBak.put(pkg1,curT);cMap.put(pkg1,mtime);if(cntNums!=null){cntMap.put(pkg1,cntNums);}}}}}}}ui.showShortToast('读取music变量');parseCnt=0;for(str:globalVarOf$musicApp){if(++parseCnt==50){Thread.sleep(150);parseCnt=0;}if(str!=null){mtime=10;if(str.charAt(str.length()-1)=='@'){mtime|=4;str=str.substring(0,str.length()-1);}strs=str.split(' ');appInfo=pMan.getAppInfoForUser(strs[0],0);label=strs[0];if(appInfo!=null){label=appInfo.appLabel;label=(label==null||label=='')?strs[0]:label;}pkg1=Pkg.newPkg(strs[0],0);curT=System.currentTimeMillis();rMap.put(pkg1,curT);rMapBak.put(pkg1,curT);if(strs.length==1){nMap.put(strs[0],label);mtime+=_cycleTime;minV=Math.min(minV,mtime);cMap.put(pkg1,mtime);cntMap.put(pkg1,new int[]{2,2});}else{tmp=strs.length==3?strs[1]:label;nMap.put(strs[0],tmp);tmps=strs[strs.length-1].split(',');mtime+=Math.max(30,Integer.parseInt(tmps[0]))*1000;minV=Math.min(minV,mtime);cntNum=tmps.length==2?Integer.parseInt(tmps[1]):2;cntNums=new int[]{cntNum,cntNum};cMap.put(pkg1,mtime);cntMap.put(pkg1,cntNums);}}}if(cMap.size()==0){ui.showShortToast('管家变量内容为空!');return;}}aSet=new HashSet();tSet=new HashSet();noSet=new HashSet();parseCnt=0;for(str:globalVarOf$audioApp){if(++parseCnt==50){Thread.sleep(150);parseCnt=0;}if(str!=null){aSet.add(str.split(' ')[0]);}}parseCnt=0;for(str:globalVarOf$topApp){if(++parseCnt==50){Thread.sleep(150);parseCnt=0;}if(str!=null){tSet.add(str.split(' ')[0]);}}parseCnt=0;for(str:globalVarOf$noTrimProcess){if(++parseCnt==50){Thread.sleep(150);parseCnt=0;}if(str!=null){noSet.add(str.split(' ')[0]);}}ruleKV.put('bgManagerLtt',rMap);sbTrim=new StringBuilder();sbKill=new StringBuilder();pat=java.time.format.DateTimeFormatter.ofPattern('MM/dd HH:mm:ss');procMaker=thanos.class.getClassLoader().loadClass('github.tornaco.android.thanos.core.os.ProcessName').getConstructor(String,int);procMaker.setAccessible(true);raFilter=new ArrayList();runAppList=new ArrayList();procNames=new Object[20];pRecords=new Object[20];logN='多开后台管家.log';st=100;aMan=thanos.activityManager;io.writeAppend(logN,'=============管家初始化完成=============\n');logSize=Files.size(Paths.get(fp,'profile_user_io',logN));ui.showShortToast('多开后台管家已开启');while(true){if(ruleKV.get('bgManagerThread')!=curThread){log.log(curThread.name+'终止运行=====');curThread.interrupt();}Thread.sleep(st);if(true){runApps=aMan.runningAppPackages;maxSize=runApps.size();j=Math.min(50,maxSize);for(i=0;i<j;i++){curPkg=runApps.get(i);if(cMap.containsKey(curPkg)){raFilter.add(curPkg);}}j=Math.min(100,maxSize);for(i=50;i<j;i++){curPkg=runApps.get(i);if(cMap.containsKey(curPkg)){raFilter.add(curPkg);}}j=Math.min(150,maxSize);for(i=100;i<j;i++){curPkg=runApps.get(i);if(cMap.containsKey(curPkg)){raFilter.add(curPkg);}}j=Math.min(200,maxSize);for(i=150;i<j;i++){curPkg=runApps.get(i);if(cMap.containsKey(curPkg)){raFilter.add(curPkg);}}j=Math.min(250,maxSize);for(i=200;i<j;i++){curPkg=runApps.get(i);if(cMap.containsKey(curPkg)){raFilter.add(curPkg);}}j=Math.min(300,maxSize);for(i=250;i<j;i++){curPkg=runApps.get(i);if(cMap.containsKey(curPkg)){raFilter.add(curPkg);}}}parseCnt=0;st=0;minT=minV;curT=System.currentTimeMillis();for(curPkg:raFilter){if(++parseCnt==50){Thread.sleep(150);parseCnt=0;}ltt=(long)rMap.get(curPkg);lttOld=(long)rMapBak.get(curPkg);if(lttOld!=ltt){cntInts=cntMap.get(curPkg);if(cntInts!=null){cntInts[0]=cntInts[1];}}cn=(long)cMap.get(curPkg);ntT=ltt+cn-curT;if(ntT<=2500){runAppList.add(curPkg);rMap.put(curPkg,curT);rMapBak.put(curPkg,curT);}else if(ntT<=10000){st=10000;}else{minT=Math.min(minT,ntT);}}st=(st!=0)?st:minT;if(runAppList.size()!=0){tork=false;focusApp=aMan.getTopVisibleActivities().get(0).name.getPackageName();label=focusApp;appInfo=pMan.getAppInfo(focusApp);if(appInfo!=null){label=appInfo.appLabel;label=(label==null||label=='')?focusApp:label;}sbKill.append('时间: ').append(java.time.LocalDateTime.now().format(pat)).append('\n正使用: ').append(label).append('\n|清理掉的后台|\n');sbTrim.append('|瘦身掉的进程|\n');parseCnt=0;frontApp=activity.frontAppPackage;for(curPkg:runAppList){if(++parseCnt==50){Thread.sleep(150);parseCnt=0;}name=curPkg.pkgName;id=curPkg.userId;cn=(long)cMap.get(curPkg);if(!(name.equals(frontApp)||name.equals(focusApp))){isplay=thanos.audioManager.hasAudioFocus(curPkg);isTrim=true;skip=true;if((cn&2)!=0){if(isplay){skip=false;cntInts=cntMap.get(curPkg);cntInts[0]=cntInts[1];}else if(!(tSet.contains(name)&&aMan.hasTopVisibleActivities(curPkg)||(cn&4)!=0&&thanos.notificationManager.hasShowingNotificationRecordsForPackage(curPkg))){skip=false;cntInts=cntMap.get(curPkg);cntInts[0]=cntInts[0]-1;if(cntInts[0]==0){isTrim=false;cntInts[0]=cntInts[1];}}}else{isTrim=(cn&1)==0;if(isTrim){cntInts=cntMap.get(curPkg);if(cntInts!=null){cntInts[0]=cntInts[0]-1;if(cntInts[0]==0){isTrim=false;cntInts[0]=cntInts[1];}}}skip=aSet.contains(name)&&isplay||tSet.contains(name)&&aMan.hasTopVisibleActivities(curPkg)||(cn&4)!=0&&thanos.notificationManager.hasShowingNotificationRecordsForPackage(curPkg);}if(!skip){if(isTrim){infoCnt=0;for(proc:aMan.getRunningAppProcessForPackage(curPkg)){if(++parseCnt==50){Thread.sleep(150);parseCnt=0;}if(!noSet.contains(proc.processName)){pRecords[infoCnt]=proc;procNames[infoCnt++]=procMaker.newInstance(proc.processName,id);}}if(infoCnt>0){_profile.publishStringFactInternal(1,'backAppTrim',0,java.util.Arrays.copyOf(procNames,infoCnt));sbTrim.append(nMap.get(name)).append('{userId:').append(id).append('}\n');for(i=0;i<infoCnt;i++){if(++parseCnt==50){Thread.sleep(150);parseCnt=0;}pRecord=pRecords[i];sbTrim.append('进程号: ').append(pRecord.pid).append(' ').append(pRecord.processName).append('\n');}tork=true;}}else{_profile.publishStringFactInternal(1,'backAppKill',0,new Object[]{curPkg});sbKill.append(nMap.get(name)).append('{userId:').append(id).append('}\n');tork=true;}}}}if(tork){logStr=sbKill.append(sbTrim).append('---------------\n').toString();if(logSize>=131072){logSize=0;io.write(logN,logStr);}else{io.writeAppend(logN,logStr);}logSize+=logStr.getBytes(StandardCharsets.UTF_8).length;}sbTrim.setLength(0);sbKill.setLength(0);runAppList.clear();}raFilter.clear();}"]}]